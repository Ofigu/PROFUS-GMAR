<!DOCTYPE html>
<html>
<head>
  <title>Trade Coins</title>
  <style>
    /* Set a fixed width and height for the coin images */
    td img {
      width: 40px; /* Adjust the desired width */
      height: 40px; /* Adjust the desired height */
    }

    /* Increase spacing between table cells */
    td, th {
      padding: 10px;
    }
    
    /* Increase spacing between table rows */
    tbody tr {
      margin-bottom: 10px;
    }

    .search-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Coins List</h1>
  <p>Balance: $<span id="balance"></span></p>
  
  <div class="search-filters">
    <div>
      <label for="searchInput">Search:</label>
      <input type="text" id="searchInput" oninput="filterCoins()" placeholder="Search by coin name">
    </div>
  
    <div>
      <label for="maxPriceInput">Max Price:</label>
      <input type="number" id="maxPriceInput" oninput="filterCoins()" step="0.01" placeholder="Enter max price">
    </div>
  
    <div>
      <label for="recommendedInput">Recommended:</label>
      <input type="checkbox" id="recommendedInput" onclick="filterCoins()">
    </div>
  
    <div>
      <label for="altCoinInput">Alt Coin:</label>
      <input type="checkbox" id="altCoinInput" onclick="filterCoins()">
    </div>
  
    <div>
      <label for="proofOfWorkInput">Proof of Work:</label>
      <input type="checkbox" id="proofOfWorkInput" onclick="filterCoins()">
    </div>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Image</th>
        <th>Coin Name</th>
        <th>Price</th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody id="coinTableBody">
      <!-- Coins will be dynamically added here -->
    </tbody>
  </table>

  <h2>Purchased Coins</h2>
  <table>
    <thead>
      <tr>
        <th>Coin Name</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody id="purchasedCoinsTableBody">
      <!-- Purchased coins will be dynamically added here -->
    </tbody>
  </table>

  <script>
    // Array to store purchased coins
    const purchasedCoins = [];

    // Object to store coin names by ID
    const coinNames = {};

    // Function to fetch coins from the backend and populate the table
    async function fetchCoins() {
  try {
    const response = await fetch('/coins');
    const coins = await response.json();

    // Sort the coins by largest price to lowest
    coins.sort((a, b) => b.Price - a.Price);

    const coinTableBody = document.getElementById('coinTableBody');

    // Clear existing table rows
    coinTableBody.innerHTML = '';

    // Populate the table with coins
    coins.forEach((coin) => {
      const row = document.createElement('tr');

      const coinImageCell = document.createElement('td');
      const coinImage = document.createElement('img');
      coinImage.src = coin.ImageOfCoin; // Update the image source property to match your coin data structure
      coinImageCell.appendChild(coinImage);
      row.appendChild(coinImageCell);

      const coinNameCell = document.createElement('td');
      coinNameCell.textContent = coin.CoinName; // Update the coin name property to match your coin data structure
      row.appendChild(coinNameCell);

      const priceCell = document.createElement('td');
      priceCell.textContent = coin.Price;
      row.appendChild(priceCell);

      const recommendedCell = document.createElement('td');
      recommendedCell.textContent = coin.Recommended ? 'Yes' : 'No';
      // row.appendChild(recommendedCell);

      const altCoinCell = document.createElement('td');
      altCoinCell.textContent = coin.AltCoin ? 'Yes' : 'No';
      // row.appendChild(altCoinCell);

      const proofOfWorkCell = document.createElement('td');
      proofOfWorkCell.textContent = coin.ProofOfWork ? 'Yes' : 'No';
      // row.appendChild(proofOfWorkCell);

      const buyCell = document.createElement('td');
      const buyButton = document.createElement('button');
      buyButton.textContent = 'Buy';
      buyButton.onclick = () => buyCoin(coin);
      buyCell.appendChild(buyButton);
      row.appendChild(buyCell);

      const sellCell = document.createElement('td');
      const sellButton = document.createElement('button');
      sellButton.textContent = 'Sell';
      sellButton.onclick = () => sellCoin(coin);
      sellCell.appendChild(sellButton);
      row.appendChild(sellCell);

      coinTableBody.appendChild(row);
    });
  } catch (error) {
    console.error('Failed to fetch coins:', error);
  }
}


    // Function to filter coins based on search input, max price, and checkboxes
    function filterCoins() {
      const searchInput = document.getElementById('searchInput');
      const maxPriceInput = document.getElementById('maxPriceInput');
      const recommendedInput = document.getElementById('recommendedInput');
      const altCoinInput = document.getElementById('altCoinInput');
      const proofOfWorkInput = document.getElementById('proofOfWorkInput');

      const searchQuery = searchInput.value.toLowerCase();
      const maxPrice = parseFloat(maxPriceInput.value) || Infinity;
      const recommended = recommendedInput.checked;
      const altCoin = altCoinInput.checked;
      const proofOfWork = proofOfWorkInput.checked;

      const coinTableBody = document.getElementById('coinTableBody');

      const rows = coinTableBody.getElementsByTagName('tr');

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const coinName = row.getElementsByTagName('td')[1].textContent.toLowerCase();
        const price = parseFloat(row.getElementsByTagName('td')[2].textContent);
        const isRecommended = row.getElementsByTagName('td')[3].textContent.toLowerCase() === 'yes';
        const isAltCoin = row.getElementsByTagName('td')[4].textContent.toLowerCase() === 'yes';
        const isProofOfWork = row.getElementsByTagName('td')[5].textContent.toLowerCase() === 'yes';

        row.style.display =
          coinName.includes(searchQuery) &&
          price <= maxPrice &&
          (!recommended || isRecommended) &&
          (!altCoin || isAltCoin) &&
          (!proofOfWork || isProofOfWork)
            ? ''
            : 'none';
      }
    }

    // Function to buy a coin
    function buyCoin(coin) {
      const balanceElement = document.getElementById('balance');
      const balance = parseFloat(balanceElement.textContent);

      if (balance >= coin.Price) {
        // Reduce the balance
        const newBalance = balance - coin.Price;
        balanceElement.textContent = newBalance.toFixed(2);

        // Add the purchased coin to the table
        const purchasedCoinsTableBody = document.getElementById('purchasedCoinsTableBody');

        const row = document.createElement('tr');

        const coinNameCell = document.createElement('td');
        coinNameCell.textContent = coin.Name;
        row.appendChild(coinNameCell);

        const amountCell = document.createElement('td');
        const coinAmount = purchasedCoins.filter((c) => c.ID === coin.ID).length + 1;
        amountCell.textContent = coinAmount;
        row.appendChild(amountCell);

        purchasedCoinsTableBody.appendChild(row);

        // Add the purchased coin to the purchasedCoins array
        purchasedCoins.push(coin);
      } else {
        alert('Insufficient balance to buy this coin.');
      }
    }

    // Function to sell a coin
    function sellCoin(coin) {
      const balanceElement = document.getElementById('balance');
      const balance = parseFloat(balanceElement.textContent);

      // Check if the user has the coin in the purchasedCoins array
      const index = purchasedCoins.findIndex((c) => c.ID === coin.ID);
      if (index !== -1) {
        // Increase the balance
        const newBalance = balance + coin.Price;
        balanceElement.textContent = newBalance.toFixed(2);

        // Remove the sold coin from the table
        const purchasedCoinsTableBody = document.getElementById('purchasedCoinsTableBody');
        const rows = purchasedCoinsTableBody.getElementsByTagName('tr');
        const rowToRemove = rows[index];
        rowToRemove.parentNode.removeChild(rowToRemove);

        // Remove the sold coin from the purchasedCoins array
        purchasedCoins.splice(index, 1);
      } else {
        alert('You do not own this coin to sell.');
      }
    }

    // Fetch coins when the page loads
    fetchCoins();
  </script>
</body>
</html>
